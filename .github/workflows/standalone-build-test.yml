name: Standalone Build Test

on:
  workflow_call:
  workflow_dispatch:

jobs:
  standalone-build-test:
    name: Standalone Build (${{ matrix.os }}${{ matrix.openmp && ', OpenMP' || '' }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux without OpenMP
          - os: ubuntu-latest
            build_script: ./build.sh
            lib_file: libvscode_diff.so
            openmp: false
          # Linux with OpenMP
          - os: ubuntu-latest
            build_script: ./build.sh
            lib_file: libvscode_diff.so
            openmp: true
          # macOS without OpenMP
          - os: macos-latest
            build_script: ./build.sh
            lib_file: libvscode_diff.dylib
            openmp: false
          # macOS with OpenMP
          - os: macos-latest
            build_script: ./build.sh
            lib_file: libvscode_diff.dylib
            openmp: true
          # Windows without OpenMP (MSVC has built-in OpenMP, hard to disable)
          - os: windows-latest
            build_script: build.cmd
            lib_file: libvscode_diff.dll
            openmp: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OpenMP (Ubuntu)
        if: matrix.os == 'ubuntu-latest' && matrix.openmp
        run: sudo apt-get update && sudo apt-get install -y libomp-dev

      - name: Install OpenMP (macOS)
        if: matrix.os == 'macos-latest' && matrix.openmp
        run: brew install libomp

      - name: Set up MSVC (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build with standalone script
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cmd //c ${{ matrix.build_script }}
          else
            ${{ matrix.build_script }}
          fi

      - name: Verify library built
        shell: bash
        run: |
          if [ -f "${{ matrix.lib_file }}" ]; then
            echo "✓ Library built: ${{ matrix.lib_file }}"
            ls -la ${{ matrix.lib_file }}
          else
            echo "✗ Library not found: ${{ matrix.lib_file }}"
            exit 1
          fi

      - name: Setup Neovim
        uses: ./.github/actions/setup-neovim

      - name: Run integration test (Ubuntu/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          nvim --headless --noplugin -u tests/init.lua \
            -c "lua require('plenary.test_harness').test_file('tests/full_integration_spec.lua', { minimal_init = vim.fn.getcwd() .. '/tests/init.lua' })"

      - name: Run integration test (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          nvim --headless --noplugin -u tests/init.lua -c "lua require('plenary.test_harness').test_file('tests/full_integration_spec.lua', { minimal_init = vim.fn.getcwd() .. '/tests/init.lua' })"
